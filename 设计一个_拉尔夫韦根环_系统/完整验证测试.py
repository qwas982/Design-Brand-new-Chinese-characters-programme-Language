"""
拉尔夫编译器完整验证测试
从最底层模块开始，逐步验证所有组件的可用性
"""

import sys
import traceback

# 测试计数器
测试通过 = 0
测试失败 = 0

def 测试(名称, 函数):
    """执行单个测试"""
    global 测试通过, 测试失败
    try:
        print(f"\n{'='*60}")
        print(f"测试: {名称}")
        print('='*60)
        函数()
        测试通过 += 1
        print(f"✓ {名称} 测试通过")
    except Exception as e:
        测试失败 += 1
        print(f"✗ {名称} 测试失败: {e}")
        traceback.print_exc()

# ============ 第1层: 代数数据类型ADT ============

def 测试_可选类型():
    """测试可选类型"""
    from 代数数据类型ADT import 可选
    
    # 创建空可选
    空 = 可选()
    assert 空.是空() == True
    assert 空.不是空() == False
    
    # 创建有值可选
    有值 = 可选(42)
    assert 有值.不是空() == True
    assert 有值.获取值() == 42
    
    # 测试映射
    映射结果 = 有值.映射(lambda x: x * 2)
    assert 映射结果.获取值() == 84
    
    # 测试绑定
    绑定结果 = 有值.绑定(lambda x: 可选(x + 1))
    assert 绑定结果.获取值() == 43
    
    print("  可选类型测试通过")

def 测试_要么类型():
    """测试Either类型"""
    from 代数数据类型ADT import 要么
    
    左 = 要么(左值=42)
    assert 左.是左值() == True
    assert 左.获取左值() == 42
    
    右 = 要么(右值="错误")
    assert 右.是右值() == True
    
    print("  要么类型测试通过")

def 测试_模式匹配():
    """测试模式匹配"""
    from 代数数据类型ADT import 模式匹配函数
    
    @模式匹配函数
    def 匹配(值):
        if 值 == 1:
            return "一"
        elif 值 == 2:
            return "二"
        return "其他"
    
    assert 匹配(1) == "一"
    assert 匹配(2) == "二"
    assert 匹配(3) == "其他"
    
    print("  模式匹配测试通过")

def 测试_词法单元ADT():
    """测试词法单元ADT"""
    from 代数数据类型ADT import (
        关键字词法单元, 标识符词法单元, 数字词法单元,
        字符串词法单元, 运算符词法单元, 分隔符词法单元,
        文件结束词法单元
    )
    
    # 关键字
    关键字 = 关键字词法单元(值="循环", 行号=1, 列号=1, 位置=0)
    assert 关键字.值 == "循环"
    assert 关键字.行号 == 1
    
    # 标识符
    标识符 = 标识符词法单元(值="变量名", 行号=1, 列号=1, 位置=5)
    assert 标识符.值 == "变量名"
    
    # 数字
    数字 = 数字词法单元(值=42, 行号=1, 列号=1, 位置=10)
    assert 数字.值 == 42
    
    # 字符串
    字符串 = 字符串词法单元(值="测试", 行号=1, 列号=1, 位置=15)
    assert 字符串.值 == "测试"
    
    # 文件结束
    结束 = 文件结束词法单元(行号=10, 列号=1, 位置=100)
    assert 结束 is not None
    
    print("  词法单元ADT测试通过")

def 测试_AST节点ADT():
    """测试AST节点ADT"""
    from 代数数据类型ADT import (
        程序节点, 循环节点, 块节点,
        验证节点, 条件节点, 字面量节点, 标识符节点,
        访问者协议
    )
    
    # 创建访问者实现
    class 测试访问者(访问者协议):
        def 访问程序节点(self, 节点): return "程序"
        def 访问循环节点(self, 节点): return "循环"
        def 访问验证节点(self, 节点): return "验证"
        def 访问持久化节点(self, 节点): return "持久化"
        def 访问AI调用节点(self, 节点): return "AI调用"
        def 访问条件节点(self, 节点): return "条件"
        def 访问块节点(self, 节点): return "块"
        def 访问关键字词法单元(self, 节点): return "关键字"
        def 访问字面量节点(self, 节点): return "字面量"
        def 访问标识符节点(self, 节点): return "标识符"
        def 访问二元表达式节点(self, 节点): return "二元表达式"
        def 访问一元表达式节点(self, 节点): return "一元表达式"
        def 访问函数调用节点(self, 节点): return "函数调用"
    
    访问者 = 测试访问者()
    
    # 字面量节点
    字面量 = 字面量节点(值=42, 类型="整数")
    结果 = 字面量.接受访问者(访问者)
    assert 结果 == "字面量"
    
    # 标识符节点
    标识符 = 标识符节点(名称="x")
    结果 = 标识符.接受访问者(访问者)
    assert 结果 == "标识符"
    
    # 块节点
    块 = 块节点(语句列表=[])
    结果 = 块.接受访问者(访问者)
    assert 结果 == "块"
    
    # 循环节点
    循环 = 循环节点(循环次数=字面量, 循环体=块)
    结果 = 循环.接受访问者(访问者)
    assert 结果 == "循环"
    
    # 程序节点
    程序 = 程序节点(语句列表=[循环])
    结果 = 程序.接受访问者(访问者)
    assert 结果 == "程序"
    
    print("  AST节点ADT测试通过")

def 测试_指令ADT():
    """测试指令ADT"""
    from 代数数据类型ADT import 指令
    
    指令1 = 指令(操作码="推入", 操作数=42)
    assert 指令1.操作码 == "推入"
    assert 指令1.操作数 == 42
    
    指令2 = 指令(操作码="加法")
    assert 指令2.操作数 is None
    
    print("  指令ADT测试通过")

# ============ 第2层: 异常处理 ============

def 测试_异常处理():
    """测试异常处理模块"""
    from 异常处理 import 异常处理中心, 错误节点, 错误类型, 错误级别
    
    # 错误节点
    错误 = 错误节点(
        错误信息="测试错误",
        行号=10,
        列号=5,
        错误类型=错误类型.词法错误,
        严重程度=错误级别.警告
    )
    assert 错误.错误信息 == "测试错误"
    assert 错误.行号 == 10
    
    # 转换字典
    字典 = 错误.转字典()
    assert 字典["错误信息"] == "测试错误"
    
    # 异常处理中心
    中心 = 异常处理中心()
    assert 中心.有错误() == False
    
    中心.创建错误节点(
        错误信息="错误1",
        行号=1, 列号=1,
        错误类型=错误类型.词法错误
    )
    中心.创建错误节点(
        错误信息="错误2",
        行号=2, 列号=2,
        错误类型=错误类型.语法错误
    )
    
    assert 中心.有错误() == True
    assert 中心.获取错误数量() == 2
    
    错误列表 = 中心.获取所有错误()
    assert len(错误列表) == 2
    
    中心.清除错误记录()
    assert 中心.获取错误数量() == 0
    
    print("  异常处理测试通过")

# ============ 第3层: 拉尔夫原语 ============

def 测试_拉尔夫原语():
    """测试拉尔夫原语"""
    from 拉尔夫原语 import (
        创建环, 创建验证器, 创建状态管理器, 创建AI调用器,
        任务状态, 环执行, 客观验证, 状态感知, AI调用器接口
    )
    
    # 创建原语
    环 = 创建环(最大迭代次数=10)
    验证器 = 创建验证器()
    状态管理器 = 创建状态管理器("/tmp")
    AI调用器 = 创建AI调用器()
    
    assert 环 is not None
    assert 验证器 is not None
    assert 状态管理器 is not None
    assert AI调用器 is not None
    
    # 测试任务状态
    状态 = 任务状态()
    assert 状态.迭代次数 == 0
    assert 状态.项目路径 == ""
    
    print("  拉尔夫原语测试通过")

# ============ 第4层: 词法器 ============

def 测试_词法分析器():
    """测试词法分析器"""
    from 词法器 import 增强词法分析器
    
    # 简单代码测试
    测试代码 = """循环 5:
    验证 "python test.py"
结束"""
    
    分析器 = 增强词法分析器(测试代码)
    结果 = 分析器.分析()
    
    assert 结果.不是空(), "词法分析应该成功"
    词法单元列表 = 结果.获取值()
    
    # 应该至少有: 循环, 数字, :, 验证, 字符串, 结束, EOF
    assert len(词法单元列表) >= 6
    
    # 检查第一个词法单元
    第一个 = 词法单元列表[0]
    from 代数数据类型ADT import 关键字词法单元
    assert isinstance(第一个, 关键字词法单元)
    assert 第一个.值 == "循环"
    
    # 检查错误处理
    测试代码_错误 = """循环 5:
    验证 \"python test.py\"
    @未知符号
结束"""
    
    分析器2 = 增强词法分析器(测试代码_错误)
    结果2 = 分析器2.分析()
    
    # 应该记录错误但仍然返回结果
    错误列表 = 分析器2.获取错误列表()
    assert len(错误列表) > 0
    
    print("  词法分析器测试通过")

# ============ 第5层: 解析器 ============

def 测试_解析器():
    """测试解析器"""
    from 词法器 import 增强词法分析器
    from 解析器 import 增强递归下降解析器
    
    测试代码 = """循环 3:
    验证 "test"
结束"""
    
    # 词法分析
    分析器 = 增强词法分析器(测试代码)
    词法结果 = 分析器.分析()
    assert 词法结果.不是空()
    词法单元列表 = 词法结果.获取值()
    
    # 语法分析
    解析器 = 增强递归下降解析器(词法单元列表)
    解析结果 = 解析器.解析()
    
    assert 解析结果.不是空(), "语法分析应该成功"
    AST根节点 = 解析结果.获取值()
    
    # 检查AST结构
    from 代数数据类型ADT import 程序节点
    assert isinstance(AST根节点, 程序节点)
    assert len(AST根节点.语句列表) == 1
    
    # 遍历AST
    遍历结果 = []
    AST根节点.遍历(lambda 节点: 遍历结果.append(type(节点).__name__))
    assert "循环节点" in 遍历结果
    
    print("  解析器测试通过")

def 测试_复杂解析():
    """测试复杂语法解析"""
    from 词法器 import 增强词法分析器
    from 解析器 import 增强递归下降解析器
    
    测试代码 = """循环 3:
    验证 "python test.py"
    如果 验证通过:
        持久化 "./结果.json"
    否则:
        调用AI "测试失败"
    结束
结束"""
    
    # 词法分析
    分析器 = 增强词法分析器(测试代码)
    词法结果 = 分析器.分析()
    assert 词法结果.不是空()
    
    # 语法分析
    解析器 = 增强递归下降解析器(词法结果.获取值())
    解析结果 = 解析器.解析()
    
    assert 解析结果.不是空()
    AST根节点 = 解析结果.获取值()
    
    # 遍历并检查所有节点类型
    节点类型列表 = []
    AST根节点.遍历(lambda 节点: 节点类型列表.append(type(节点).__name__))
    
    # 应该包含: 程序节点, 循环节点, 验证节点, 条件节点, 块节点, 持久化节点, AI调用节点
    必要节点 = ["循环节点", "验证节点", "条件节点", "持久化节点", "AI调用节点", "块节点"]
    for 节点 in 必要节点:
        assert 节点 in 节点类型列表, f"缺少 {节点}"
    
    print("  复杂解析测试通过")

# ============ 第6层: 代码生成器 ============

def 测试_代码生成器():
    """测试代码生成器"""
    from 代码生成器 import 增强代码生成器, 代码生成器配置
    from 代数数据类型ADT import (
        程序节点, 循环节点, 块节点, 验证节点, 条件节点,
        字面量节点, 标识符节点, 访问者协议
    )
    
    # 创建测试AST
    测试程序 = 程序节点(
        语句列表=[
            循环节点(
                循环次数=字面量节点(值=3, 类型="整数"),
                循环体=块节点(
                    语句列表=[
                        验证节点(
                            验证命令=字面量节点(值="echo test", 类型="字符串")
                        )
                    ]
                )
            )
        ]
    )
    
    # 生成代码
    配置 = 代码生成器配置(是否生成调试信息=True, 优化级别=0)
    生成器 = 增强代码生成器(配置)
    指令序列 = 生成器.生成代码(测试程序)
    
    assert len(指令序列) > 0
    
    # 检查指令类型
    操作码列表 = [指令.操作码 for 指令 in 指令序列]
    assert "停机" in 操作码列表
    assert "标签" in 操作码列表
    assert "推入" in 操作码列表
    assert "调用外部" in 操作码列表
    
    # 检查符号表
    符号表 = 生成器.获取符号表()
    assert isinstance(符号表, dict)
    
    print("  代码生成器测试通过")

# ============ 第7层: 编译管道 ============

def 测试_编译管道():
    """测试编译管道"""
    from 编译管道 import 拉尔夫编译管道, 编译管道配置
    
    测试代码 = """循环 3:
    验证 "python test.py"
    如果 验证通过:
        持久化 "./结果.json"
    否则:
        调用AI "测试失败，请分析"
    结束
结束"""
    
    # 创建编译管道
    配置 = 编译管道配置(
        是否启用优化=True,
        优化级别=1,
        是否保留调试信息=True
    )
    管道 = 拉尔夫编译管道(配置)
    
    # 编译
    结果 = 管道.编译(测试代码)
    
    assert 结果.不是空(), "编译应该成功"
    指令序列 = 结果.获取值()
    
    assert len(指令序列) > 0
    
    # 检查编译统计
    统计 = 管道.编译统计
    assert "词法单元数量" in 统计
    assert "AST节点数" in 统计
    assert "原始指令数" in 统计
    
    print("  编译管道测试通过")

def 测试_便捷编译函数():
    """测试便捷编译函数"""
    from 编译管道 import 编译
    
    测试代码 = """循环 2:
    验证 "echo hello"
结束"""
    
    # 使用便捷函数（不优化）
    结果 = 编译(测试代码, 优化级别=0)
    
    assert 结果.不是空()
    指令序列 = 结果.获取值()
    assert len(指令序列) > 0
    
    # 检查指令
    操作码列表 = [指令.操作码 for 指令 in 指令序列]
    assert "停机" in 操作码列表
    
    print("  便捷编译函数测试通过")

# ============ 第8层: 完整工作流 ============

def 测试_完整工作流():
    """测试完整工作流"""
    from 完整工作流 import 完整工作流, 拉尔夫韦根系统
    
    # 验证完整工作流类存在
    assert 完整工作流 is not None
    
    # 验证拉尔夫韦根系统类存在
    assert 拉尔夫韦根系统 is not None
    
    # 创建一个工作流实例
    工作流 = 完整工作流()
    
    assert 工作流 is not None
    assert hasattr(工作流, '编译程序')
    assert hasattr(工作流, '执行程序')
    assert hasattr(工作流, '生成执行报告')
    
    print("  完整工作流测试通过")

def 测试_集成调试器():
    """测试集成调试器"""
    from 集成调试器 import 拉尔夫集成调试器, 创建调试器, 创建栈机
    
    调试器 = 创建调试器()
    
    assert 调试器 is not None
    assert hasattr(调试器, '设置断点')
    assert hasattr(调试器, '单步执行')
    assert hasattr(调试器, '运行到下一个断点')
    assert hasattr(调试器, '输出当前状态')
    
    # 测试栈机创建
    栈机 = 创建栈机()
    assert 栈机 is not None
    
    print("  集成调试器测试通过")

# ============ 运行所有测试 ============

if __name__ == "__main__":
    print("\n" + "="*60)
    print("拉尔夫编译器完整验证测试")
    print("="*60)
    
    # 第1层: 代数数据类型ADT
    测试("代数数据类型ADT - 可选类型", 测试_可选类型)
    测试("代数数据类型ADT - 要么类型", 测试_要么类型)
    测试("代数数据类型ADT - 模式匹配", 测试_模式匹配)
    测试("代数数据类型ADT - 词法单元ADT", 测试_词法单元ADT)
    测试("代数数据类型ADT - AST节点ADT", 测试_AST节点ADT)
    测试("代数数据类型ADT - 指令ADT", 测试_指令ADT)
    
    # 第2层: 异常处理
    测试("异常处理模块", 测试_异常处理)
    
    # 第3层: 拉尔夫原语
    测试("拉尔夫原语", 测试_拉尔夫原语)
    
    # 第4层: 词法器
    测试("词法分析器", 测试_词法分析器)
    
    # 第5层: 解析器
    测试("解析器", 测试_解析器)
    测试("复杂解析", 测试_复杂解析)
    
    # 第6层: 代码生成器
    测试("代码生成器", 测试_代码生成器)
    
    # 第7层: 编译管道
    测试("编译管道", 测试_编译管道)
    测试("便捷编译函数", 测试_便捷编译函数)
    
    # 第8层: 完整工作流
    测试("完整工作流", 测试_完整工作流)
    测试("集成调试器", 测试_集成调试器)
    
    # 总结
    print("\n" + "="*60)
    print("测试总结")
    print("="*60)
    print(f"测试通过: {测试通过}")
    print(f"测试失败: {测试失败}")
    print(f"总计: {测试通过 + 测试失败}")
    
    if 测试失败 == 0:
        print("\n✓ 所有测试通过！拉尔夫编译器完全可用。")
        sys.exit(0)
    else:
        print(f"\n✗ 有 {测试失败} 个测试失败")
        sys.exit(1)
