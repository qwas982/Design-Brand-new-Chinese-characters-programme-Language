#lang racket

;; æ‹‰å°”å¤«Â·éŸ¦æ ¹å¾ªç¯æ ¸å¿ƒåŸè¯­ - Racketå®ç°
;; ç”¨æ³•: (require "æ‹‰å°”å¤«åŸè¯­.rkt")

(require json)
(provide å¾ªç¯æ‰§è¡Œ å®¢è§‚éªŒè¯ çŠ¶æ€æ„ŸçŸ¥ 
         ä»»åŠ¡çŠ¶æ€? ä»»åŠ¡çŠ¶æ€-è¿­ä»£æ¬¡æ•° 
         ä»»åŠ¡çŠ¶æ€-é¡¹ç›®è·¯å¾„ ä»»åŠ¡çŠ¶æ€-æ—¥å¿—æ–‡ä»¶
         åˆ›å»ºå¾ªç¯ åˆ›å»ºéªŒè¯å™¨ åˆ›å»ºçŠ¶æ€ç®¡ç†å™¨)

;; ==================== æ•°æ®ç»“æ„å®šä¹‰ ====================
(struct ä»»åŠ¡çŠ¶æ€ (è¿­ä»£æ¬¡æ•° é¡¹ç›®è·¯å¾„ æ—¥å¿—æ–‡ä»¶ å®Œæˆæ ‡å¿—)
  #:transparent
  #:mutable)

;; ==================== å¾ªç¯æ‰§è¡ŒåŸè¯­ ====================
(define (å¾ªç¯æ‰§è¡Œ ä»»åŠ¡å‡½æ•° åˆå§‹çŠ¶æ€ 
                 #:æœ€å¤§è¿­ä»£æ¬¡æ•° [æœ€å¤§è¿­ä»£æ¬¡æ•° 50]
                 #:å®Œæˆæ£€æŸ¥ [å®Œæˆæ£€æŸ¥å‡½æ•° #f])
  (let å¾ªç¯ ([å½“å‰çŠ¶æ€ åˆå§‹çŠ¶æ€]
            [è®¡æ•° 0])
    (cond
      ;; æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€å¤§è¿­ä»£
      [(>= è®¡æ•° æœ€å¤§è¿­ä»£æ¬¡æ•°)
       (printf "âš ï¸ è¾¾åˆ°å®‰å…¨è¿­ä»£ä¸Šé™ï¼Œå¼ºåˆ¶ç»ˆæ­¢\n")
       å½“å‰çŠ¶æ€]
      
      ;; æ£€æŸ¥å®Œæˆæ¡ä»¶
      [(and å®Œæˆæ£€æŸ¥å‡½æ•° (å®Œæˆæ£€æŸ¥å‡½æ•° å½“å‰çŠ¶æ€))
       (printf "âœ… ä»»åŠ¡è¾¾æˆå®¢è§‚æ ‡å‡†ï¼Œå¾ªç¯ç»ˆæ­¢\n")
       å½“å‰çŠ¶æ€]
      
      ;; ç»§ç»­è¿­ä»£
      [else
       (set-ä»»åŠ¡çŠ¶æ€-è¿­ä»£æ¬¡æ•°! å½“å‰çŠ¶æ€ (+ è®¡æ•° 1))
       (printf "\n=== è¿­ä»£ç¬¬~aè½®å¼€å§‹ ===\n" (ä»»åŠ¡çŠ¶æ€-è¿­ä»£æ¬¡æ•° å½“å‰çŠ¶æ€))
       
       ;; æ‰§è¡Œä»»åŠ¡å‡½æ•°
       (define æ–°çŠ¶æ€ (ä»»åŠ¡å‡½æ•° å½“å‰çŠ¶æ€))
       
       ;; ç»§ç»­å¾ªç¯
       (å¾ªç¯ æ–°çŠ¶æ€ (+ è®¡æ•° 1))])))

;; ==================== å®¢è§‚éªŒè¯åŸè¯­ ====================
(define å®¢è§‚éªŒè¯
  (let ()
    ;; å†…éƒ¨è¾…åŠ©å‡½æ•°
    (define (æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ å‘½ä»¤ å·¥ä½œç›®å½•)
      (parameterize ([current-directory å·¥ä½œç›®å½•])
        (let ([æˆåŠŸ? (system å‘½ä»¤)])
          æˆåŠŸ?)))
    
    ;; å…¬å…±æ¥å£
    (Î» (æ“ä½œ . å‚æ•°)
      (case æ“ä½œ
        ['æ‰§è¡Œæµ‹è¯•
         (let ([æµ‹è¯•å‘½ä»¤ (first å‚æ•°)]
               [å·¥ä½œç›®å½• (if (>= (length å‚æ•°) 2) 
                           (second å‚æ•°) 
                           (current-directory))])
           (if (æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ æµ‹è¯•å‘½ä»¤ å·¥ä½œç›®å½•)
               (begin (printf "âœ… éªŒè¯é€šè¿‡: ~a\n" æµ‹è¯•å‘½ä»¤) #t)
               (begin (printf "âŒ éªŒè¯å¤±è´¥\n") #f)))]
        
        ['æ£€æŸ¥æ¡ä»¶
         (let ([æ¡ä»¶å‡½æ•° (first å‚æ•°)]
               [æè¿° (if (>= (length å‚æ•°) 2) 
                        (second å‚æ•°) 
                        "")])
           (with-handlers ([exn:fail? 
                            (Î» (e) 
                              (printf "âš ï¸ æ¡ä»¶æ£€æŸ¥å¼‚å¸¸: ~a\n" (exn-message e))
                              #f)])
             (define ç»“æœ (æ¡ä»¶å‡½æ•°))
             (printf "~a æ¡ä»¶æ£€æŸ¥: ~a\n" 
                     (if ç»“æœ "âœ…" "âŒ") æè¿°)
             ç»“æœ))]
        
        [else (error "æœªçŸ¥æ“ä½œ:" æ“ä½œ)]))))

;; ==================== çŠ¶æ€æ„ŸçŸ¥åŸè¯­ ====================
(struct çŠ¶æ€ç®¡ç†å™¨ (é¡¹ç›®è·¯å¾„)
  #:transparent
  #:mutable)

(define (åˆ›å»ºçŠ¶æ€ç®¡ç†å™¨ é¡¹ç›®è·¯å¾„)
  (make-directory* é¡¹ç›®è·¯å¾„)  ;; ç¡®ä¿ç›®å½•å­˜åœ¨
  (çŠ¶æ€ç®¡ç†å™¨ é¡¹ç›®è·¯å¾„))

(define (çŠ¶æ€ç®¡ç†å™¨-ä¿å­˜çŠ¶æ€ ç®¡ç†å™¨ çŠ¶æ€æ•°æ®)
  (let* ([çŠ¶æ€æ–‡ä»¶ (build-path (çŠ¶æ€ç®¡ç†å™¨-é¡¹ç›®è·¯å¾„ ç®¡ç†å™¨) 
                           "é¡¹ç›®çŠ¶æ€.json")]
         [å®Œæ•´æ•°æ® (hash-set çŠ¶æ€æ•°æ® 
                           '_æœ€åæ›´æ–° 
                           (date->string (current-date) #t))])
    
    (with-output-to-file çŠ¶æ€æ–‡ä»¶
      (Î» () (write-json å®Œæ•´æ•°æ®))
      #:exists 'replace)
    
    (printf "ğŸ’¾ çŠ¶æ€å·²ä¿å­˜åˆ°: ~a\n" çŠ¶æ€æ–‡ä»¶)))

(define (çŠ¶æ€ç®¡ç†å™¨-åŠ è½½çŠ¶æ€ ç®¡ç†å™¨)
  (let ([çŠ¶æ€æ–‡ä»¶ (build-path (çŠ¶æ€ç®¡ç†å™¨-é¡¹ç›®è·¯å¾„ ç®¡ç†å™¨) 
                          "é¡¹ç›®çŠ¶æ€.json")])
    (if (file-exists? çŠ¶æ€æ–‡ä»¶)
        (with-input-from-file çŠ¶æ€æ–‡ä»¶ read-json)
        (hash 'è¿­ä»£å†å² '() 'é”™è¯¯æ—¥å¿— '()))))

(define (çŠ¶æ€ç®¡ç†å™¨-è®°å½•æ—¥å¿— ç®¡ç†å™¨ äº‹ä»¶ æ•°æ®)
  (let* ([æ—¥å¿—æ–‡ä»¶ (build-path (çŠ¶æ€ç®¡ç†å™¨-é¡¹ç›®è·¯å¾„ ç®¡ç†å™¨) 
                           "è¿­ä»£æ—¥å¿—.json")]
         [å½“å‰æ—¥å¿— (if (file-exists? æ—¥å¿—æ–‡ä»¶)
                     (with-input-from-file æ—¥å¿—æ–‡ä»¶ read-json)
                     (hash))]
         [æ–°æ¡ç›® (hash 'æ—¶é—´æˆ³ (current-seconds)
                     'äº‹ä»¶ äº‹ä»¶
                     'æ•°æ® æ•°æ®)]
         [æ›´æ–°æ—¥å¿— (hash-update å½“å‰æ—¥å¿— 'äº‹ä»¶æ—¥å¿— 
                              (Î» (æ—¥å¿—åˆ—è¡¨) (cons æ–°æ¡ç›® æ—¥å¿—åˆ—è¡¨)) '())])
    
    (with-output-to-file æ—¥å¿—æ–‡ä»¶
      (Î» () (write-json æ›´æ–°æ—¥å¿—))
      #:exists 'replace)))

;; ==================== å·¥å‚å‡½æ•° ====================
(define (åˆ›å»ºå¾ªç¯ #:æœ€å¤§è¿­ä»£æ¬¡æ•° [æœ€å¤§è¿­ä»£æ¬¡æ•° 50])
  (curry å¾ªç¯æ‰§è¡Œ #:æœ€å¤§è¿­ä»£æ¬¡æ•° æœ€å¤§è¿­ä»£æ¬¡æ•°))

(define (åˆ›å»ºéªŒè¯å™¨) å®¢è§‚éªŒè¯)